<!-- {{ site | jsonify }} -->

{% if page.name == "index.md" %}{% assign isindex = true %}{% endif %}

{% assign campaigns = "" | split: "," %}{% for p in site.pages %}{% if p.path contains "data/campaigns/" and p.layout == "index" %}{% assign campaigns = campaigns | push: p %}{% endif %}{% endfor %}{% assign campaigns = campaigns | sort: "name" %}

{% if isindex %}

{% assign index = page %}
{% assign campaign_name = "" %}

{% assign events = "" | split: "," %}{% for p in site.pages %}{% if p.path contains "data/campaigns/" and p.layout != "index" %}{% assign events = events | push: p %}{% endif %}{% endfor %}
{% for campaign in campaigns %}{% for event in campaign.events %}{% assign events = events | push: event %}{% endfor %}{% endfor %}

{% else %}

{% assign index = "" %}{% for p in site.pages %}{% if p.path == "data/index/index.md" %}{% assign index = p %}{% endif %}{% endfor %}
{% assign campaign = page %}
{% assign campaign_name = page.name | replace: ".md", "" %}

{% assign events = "" | split: "," %}{% if campaign.events %}{% assign events = campaign.events %}{% endif %}{% for p in site.pages %}{% if p.path contains "data/campaigns/" and p.dir contains campaign_name and p.layout != "index" %}{% assign events = events | push: p %}{% endif %}{% endfor %}

{% endif %}

{% assign events_grouped_by_country = events | sort: "country" | group_by: "country" %}


<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta property="og:locale" content="en_US" />
        <meta property="og:type" content="website" />
        <meta name="twitter:card" content="summary" />

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
   integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
   crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
   integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
   crossorigin=""></script>
        <!--<script type="text/javascript"
            src="https://cdn.jsdelivr.net/gh/hosuaby/Leaflet.SmoothMarkerBouncing@v3.0.2/dist/bundle.js"
            crossorigin="anonymous"></script>-->

        <link href="https://tile.openstreetmap.org/{z}/{x}/{y}.png" id="link_tiles" />
        <link href="https://maps.google.com/maps/place/{name}/@{latlon},12z" id="link_maps_google_pattern" />
        <link href="https://maps.apple.com/?q={name}&ll=@{latlon}&z=12" id="link_maps_apple_pattern" />

        <link rel="stylesheet" href="{{ site.github.url }}/assets/css/style.css" />
        <script src="{{ site.github.url }}/assets/js/script.js"></script>

        <meta property="og:site_name"    content="Event map [{{ index.title    | xml_escape }}]" />

        {% if isindex %}
        <meta property="og:url" content="{{ site.github.url }}" />
        <link rel="canonical"      href="{{ site.github.url }}" />

        <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","headline":{{ index.title | jsonify }},"name": {{index.title | jsonify }},"url":"{{ site.github.url }}}</script>
        {% if index.logo %}
            <meta name="twitter:image" content="{{ site.github.url }}/{{ index.path | replace: "index.md", index.logo }}" />
            <meta property="og:image"  content="{{ site.github.url }}/{{ index.path | replace: "index.md", index.logo }}" />
            <link rel="icon"              href="{{ site.github.url }}/{{ index.path | replace: "index.md", index.logo }}" />
        {% endif %}

        {% else %}
        <meta property="og:url" content="{{ site.github.url | xml_escape }}{{ page.url | xml_escape }}" />
        <link rel="canonical"      href="{{ site.github.url | xml_escape }}{{ page.url | xml_escape }}" />

        <meta name="twitter:description" content="Event map [{{ campaign.title | xml_escape }}]" />
        <meta name="description"         content="Event map [{{ campaign.title | xml_escape }}]" />
        <meta property="og:title"        content="Event map [{{ campaign.title | xml_escape }}]" />
        <meta property="twitter:title"   content="Event map [{{ campaign.title | xml_escape }}]" />

        <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","headline":{{ campaign.title | jsonify }},"name": {{ campaign.title | jsonify }},"url": {{ site.github.url | append: page.url | jsonify }} }</script>
        {% if campaign.logo %}
            <meta name="twitter:image" content="{{ site.github.url }}/{{ campaign.path | split: "/" | pop | join: "/"}}/{{ campaign.logo }}" />
            <meta property="og:image"  content="{{ site.github.url }}/{{ campaign.path | split: "/" | pop | join: "/"}}/{{ campaign.logo }}" />
            <link rel="icon"              href="{{ site.github.url }}/{{ campaign.path | split: "/" | pop | join: "/"}}/{{ campaign.logo }}" />
        {% endif %}
        {% endif %}

        <script>

var mapmarkers = {};

function body_onload()
{
    const timezone2country = {% include timezone2country.json %};

    // https://www.techighness.com/post/get-user-country-and-region-on-browser-with-javascript-only/
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const current_country = timezone2country[timezone];
    
    const today_YYYY_MM_DD = new Date().toISOString().slice(0, 10);

    const map = init_map('map');

    const actions = document.body.dataset.isindex == 'true' ? ['slideshow_populate_events', 'map_index'] : ['map_campaign', 'slideshow_populate_events'];
    for(const action of actions)
    {
        if(action == 'slideshow_populate_events')
        {
            slideshow_init(Array.from(document.querySelectorAll('a.event:not([data-photohrefs=""])')).map(a => a.dataset.eventhash));
            switch_upcoming_events(today_YYYY_MM_DD);
            if(document.body.dataset.isindex == 'true')
                switch_upcoming_campaigns(today_YYYY_MM_DD);
            populate_upcoming_events_in_country(today_YYYY_MM_DD, current_country);
            populate_upcoming_events_everywhere(today_YYYY_MM_DD);
        }
        else if(action == 'map_index')
            mapmarkers = populate_map(map, document.querySelectorAll('#upcomingeventseverywhere > li > a.event'));
        else if(action == 'map_campaign')
            mapmarkers = populate_map(map, document.querySelectorAll('a.event:not([data-latlon=""])'));
    }

    navigate(window.location.hash);
}

        </script>

        <title>{{ page.title | xml_escape}}</title>
    </head>

    <body data-isindex="{{ isindex }}" onhashchange="navigate(window.location.hash)" onload="body_onload()"><div id="outer-container">

        <h1 id="indextitle"><a href="{{ site.github.url }}">{{ index.title }}</a></h1>
        {% if isindex %}
        <div id="indexdescription">{{ index.content | markdownify }}</div>
        {% else %}
        <h2 id="campaigntitle"><a href="">{{ campaign.title }}</a></h2>
        <div id="campaigndescription">{{ campaign.content | markdownify }}</div>
        {% endif %}

        <hr />
        <div id="sticky">
            <div id="slideshow"><input data-eventhash="" data-eventidx="" type="checkbox" id="slideshow_toggle" name="slideshow_toggle" onchange="slideshow_toggle()" /><label for="slideshow_toggle">&nbsp;slideshow{% unless isindex %} for {{ campaign.title | xml_escape }} {% endunless %}</label></span></div>
            <div id="container"><div id="map"><template id="popup"><div><h3 id="place"></h3><h4 id="time"></h4></div></template></div></div>
            <div id="infopic">
                    <div id="info" class="visibilityhidden">
                        <h3 id="place">
                            <div id="place_name"></div>
                            <div id="place_date"></div>
                        </h3>
                        <h4 id="location"></h4>
                        <a target="_blank" id="link_maps_google">Google Maps</a>&nbsp;|&nbsp;<a target="_blank" id="link_maps_apple">Apple Maps</a><br />
                        <br /><a target="_blank" id="eventurl">Event Link</a>
                        <br /><a target="_blank" id="orgurl"></a>
                        <ul id="dateall"></ul>
                        <div class="eventdescription"></div>
                    </div>
                    <div id="picbox"><img data-photohrefs="" data-photohrefsidx="" onclick="img_onclick()" id="eventphoto" alt="Event photo" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" hidden /></div>
            </div>
        </div>

        <details open>
        <summary class="center">
        <span class="header">Upcoming events in <span id="country"></span></span>
        </summary>
        <ul class="events" id="upcomingeventsincountry">
            <li hidden class="eventsnone"><div class="eventsnoneerror">No upcoming events</div></li>
        </ul>
        </details>

        {% if isindex %}
        <hr />
        <details open>
        <summary class="center">
        <span class="header">Upcoming events everywhere</span>
        </summary>
        <ul class="events" id="upcomingeventseverywhere">
            <li hidden class="eventsnone"><div class="eventsnoneerror">No upcoming events</div></li>
        </ul>
        </details>
        {% endif %}

        <hr />
        <details {% unless isindex %}open{% endunless %} >
        <summary class="center">
        <span class="header">All events</span>
        </summary>

        {% if isindex %}
        <ul id="allevents" class="events">
            {% if country_events.size == 0 %}
            <li class="eventsnone"><div class="eventsnoneerror">No events</div></li>
            {% endif %}

            {% for country_events in events_grouped_by_country %}
            {% assign grouped_events = country_events.items | sort: "date" | reverse %}

            {% for event in grouped_events %}
            {% if forloop.first %}{% assign eventcity = forloop.first %}{% endif %}

            {% assign photos = "" | split: "," %}
            {% if event.photos %}
                {% for photo in event.photos %}
                    {% if photo contains "https://" %}
                        {% assign httpsphoto = photo %}
                    {% else %}
                        {% assign httpsphoto = campaign.path | split: "/" | pop | join: "/" | prepend: "/" | prepend: site.github.url | append: "/" | append: photo %}
                    {% endif %}
                    {% assign photos = photos | push: httpsphoto %}
                {% endfor %}
            {% else %}
                {% for p in site.static_files %}
                    {% if event.dir and p.extname == ".jpg" and p.path contains event.dir %}
                        {% assign photo = site.github.url | append: p.path %}
                        {% assign photos = photos | push: photo %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            {% assign campaign = nil %}
            {% for _campaign in campaigns %}
                {% assign campaign_path = _campaign.path | split: "/" | pop | join: "/" %}
                {% if event.dir contains campaign_path and  _campaign.path contains "data/campaigns/" and _campaign.layout == "index" %}
                    {% assign campaign = _campaign %}
                    {% break %}
                {% endif %}
                {% for _event in _campaign.events %}
                    {% if event == _event %}
                        {% assign campaign = _campaign %}
                        {% break %}
                    {% endif %}
                {% endfor %}
            {% endfor %}

            {% assign eventhashall = "" | split: "," %}
            {% for event in grouped_events %}
                {% if event.path %}
                    {% assign eventhash = event.path | remove: "data/campaigns/" | remove: ".md" | replace: "/", "_" | replace: " ", "_"  | prepend: "#" %}
                {% else %}
                    {% assign eventhash = campaign.url | remove_first: "/" | append: event.date | append: "-" | append: event.city | replace: "/", "_" | replace: " ", "_" | prepend: "#" %}
                {% endif %}
                {% assign eventhashall = eventhashall | push: eventhash %}
            {% endfor %}
            {% assign eventhashall = eventhashall | join: ";" %}
            {% assign dateall = grouped_events | map: "date" | join: ";" %}

            {% if event.path %}
                {% assign eventhash = event.path | remove: "data/campaigns/" | remove: ".md" | replace: "/", "_" | replace: " ", "_"  | prepend: "#" %}
            {% else %}
                {% assign eventhash = campaign.url | remove_first: "/" | append: event.date | append: "-" | append: event.city | replace: "/", "_" | replace: " ", "_" | prepend: "#" %}
            {% endif %}

            <li class="eventinactive" data-date="{{ event.date }}"><a class="event" data-address="{{ event.address }}" data-dateall="{{ dateall }}" data-eventhashall="{{ eventhashall }}" data-date="{{ event.date }}" data-time="{{ event.time }}" data-photohrefs="{{ photos | join: ";" }}" data-mapmarkerkey="{{ event.city }}, {{ event.country }}" data-latlon="{{ event.latlon }}" data-city="{{ event.city }}" data-country="{{ event.country }}" data-orgname="{{ event.orgname }}" data-orgurl="{{ event.orgurl }}" data-eventurl="{{ event.eventurl }}" data-location="{{ event.location }}" data-eventhash="{{ eventhash }}" href="{{ eventhash }}"><div>{{ event.city }}, {{ event.country }}, {% if event.location %}{{ event.location }}{% else %}{{ event.address }}{% endif %} - {{ campaign.title }}</div><div class="subtitle" title="time zone {{ event.timezone }}">{{ event.date | date: "%B %-d, %Y" }}, {{ event.time }}</div><div hidden class="eventdescription"><div>{{ event.content | markdownify }}</div></div></a></li>

            {% endfor %}
            {% endfor %}

        </ul>

        {% else %}

        <ul id="allevents" class="events">
            {% if country_events.size == 0 %}
            <li class="eventsnone"><div class="eventsnoneerror">No events</div></li>
            {% endif %}

            {% for country_events in events_grouped_by_country %}

            <li><div class="country">{{ country_events.name }}</div></li>

            {% assign events_grouped_by_city = country_events.items | sort: "city" | group_by: "city" %}
            {% for city_events in events_grouped_by_city %}
            {% assign grouped_events = city_events.items | sort: "date" | reverse %}

            {% assign eventhashall = "" | split: "," %}
            {% for event in grouped_events %}
                {% if event.path %}{% assign eventhash = event.path | remove: "data/campaigns/" | remove: ".md" | replace: "/", "_" | replace: " ", "_"  | prepend: "#" %}{% else %}{% assign eventhash = campaign.url | remove_first: "/" | append: event.date | append: "-" | append: event.city | replace: "/", "_" | replace: " ", "_" | prepend: "#" %}{% endif %}
                {% assign eventhashall = eventhashall | push: eventhash %}
            {% endfor %}
            {% assign eventhashall = eventhashall | join: ";" %}
            {% assign dateall = grouped_events | map: "date" | join: ";" %}
            
            {% for event in grouped_events %}
            
            {% if event.path %}
                {% assign eventhash = event.path | remove: "data/campaigns/" | remove: ".md" | replace: "/", "_" | replace: " ", "_"  | prepend: "#" %}
            {% else %}
                {% assign eventhash = campaign.url | remove_first: "/" | append: event.date | append: "-" | append: event.city | replace: "/", "_" | replace: " ", "_" | prepend: "#" %}
            {% endif %}
            {% if forloop.first %}
                {% assign eventcity = forloop.first %}
            {% endif %}
            {% if event.photos %}
                {% assign photos = "" | split: "," %}
                {% for photo in event.photos %}
                    {% if photo contains "https://" %}
                        {% assign httpsphoto = photo %}
                    {% else %}
                        {% assign httpsphoto = campaign.path | split: "/" | pop | join: "/" | prepend: "/" | prepend: site.github.url | append: "/" | append: photo %}
                    {% endif %}
                    {% assign photos = photos | push: httpsphoto %}
                {% endfor %}
            {% else %}
                {% for p in site.static_files %}
                    {% if p.extname == ".jpg" and p.path contains event.dir %}
                        {% assign photo = site.github.url | append: p.path %}
                        {% assign photos = photos | push: photo %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            <li class="eventinactive" data-date='{{ event.date }}'><a data-address="{{ event.address }}" data-dateall="{{ dateall }}" data-eventhashall="{{ eventhashall }}" class="event {% if eventcity %}eventcity{% endif %}" data-mapmarkerkey="{{ event.city }}, {{ event.country }}" data-iconid="" data-date='{{ event.date | date: "%B %-d, %Y" }}' data-time="{{ event.time }}" data-photohrefs="{{ photos | join: ";" }}" data-latlon="{% if event.latlon %}{{ event.latlon }}{% else %}{{ index.geocoder[event.city] }}{% endif %}" data-city="{{ event.city }}" data-country="{{ event.country }}" data-orgname="{{ event.orgname }}" data-orgurl="{{ event.orgurl }}" data-location="{{ event.location }}" data-eventurl="{{ event.eventurl }}" data-eventhash="{{ eventhash }}" href="{{ eventhash }}"><div>{{ event.city }}, {{ event.country }}, {% if event.location %}{{ event.location }}{% else %}{{ event.address }}{% endif %}</div><div class="subtitle" title="time zone {{ event.timezone }}">{{ event.date | date: "%B %-d, %Y" }}, {{ event.time }}</div><div hidden class="eventdescription"><div>{{ event.content | markdownify }}</div></div></a></li>


            {% endfor %}
            {% endfor %}
            {% endfor %}

        </ul>
        {% endif %}
        </details>

        <hr />
        <details open>
        <summary class="center">
        <span class="header">All campaigns</span>
        </summary>

        <nav>
            <ul id="allcampaigns">
            {% if campaigns.size == 0 %}
            <li class="campaignsnone"><div class="campaignsnoneerror">No campaigns</div></li>
            {% endif %}
            {% for campaign in campaigns %}{% assign d = campaign.name | replace: ".md", "" %}
                <li class="campaign {% if d != campaign_name %}campaigninactive{% else %}campaignactive{% endif %}"><a href="{{ site.github.url }}/{{ d }}"><div>{{ campaign.title | xml_escape }}</div>{% if campaign.date %}<div class="subtitle">{% if campaign.date.first %} {{ campaign.date | first | date: "%B %-d" }}{{ campaign.date | last | date: " - %B %-d, %Y" }}{% else %}{{ campaign.date | date: "%B %-d, %Y" }}{% endif %}</div>{% endif %}</a></li>
            {% endfor %}
            </ul>
        </nav>
        </details>

    </div>
    <footer>

        <hr />
        <div class="center">created with <a target="_blank" href="https://github.com/vadimkantorov/eventmap">https://github.com/vadimkantorov/eventmap</a>, page generated by Jekyll @ {{ site.time | date_to_xmlschema }}, <a target="_blank" id="map_copyright" href="http://osm.org/copyright">map &copy; OpenStreetMap</a></div>

    </footer>
    </body>


</html>
