{% assign events = "" | split: "," %}{% for p in site.pages %}{% if p.path contains "data/days/" %}{% assign events = events | push: p %}{% endif %}{% endfor %}{% assign events = events | sort: "name" %}
{% assign name_size = page.name | size | minus: 3 %}{% assign event_name = page.name | slice: 0, name_size %}
{% assign places = "" | split: "," %}{% for p in site.pages %}{% if p.path contains "data/places/" and p.dir contains event_name %}{% assign places = places | push: p %}{% endif %}{% endfor %}
{% assign places_grouped_by_country = places | sort: "country" | group_by: "country" %}

<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
   integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
   crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
   integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
   crossorigin=""></script>
        <link href="https://unpkg.com/leaflet@1.8.0/dist/images/marker-icon.png" rel="prefetch" id="link_marker_icon" type="image/png" />
        <link href="https://tile.openstreetmap.org/{z}/{x}/{y}.png" id="link_tiles" />
        <link href="https://google.com/maps/place/{name}/@{lat},{lng},12z" id="link_map" />

        <style>
#container
{
display:flex;
flex-direction:row;
min-height:400px;
}

#picBox
{
flex:5;
/*background-image:url(https://placeimg.com/1000/1000/tech);
background-size:cover;
background-repeat:no-repeat;
background-position:center;*/
}

#map
{
flex:5;
position:relative;
border:1px solid red;
}

#infoBox
{
flex:20;
border:1px solid blue;
display:none;
}

.center
{
text-align:center
}

.country
{
text-align: center; line-height: 1.4; font-size: 1.48rem; color: rgb(0, 131, 214) !important;
}
#countries, .places, #allevents
{
list-style-type: none;
padding: 0
}
.place, .event
{
color: #ffffff;
text-align: center;
text-decoration: none;
}
.places > li, #allevents >li
{
background-color: #0083d6;
border-radius: 40px;
}
.activeevent
{
background-color: red
}

.subtitle
{
opacity: 0.7;
font-size: 90%;
}

        </style>

        <script>

            function format_place_info(p)
            {
                const latlng = JSON.parse(p.dataset.latlng), locality = p.dataset.locality;

                const template_popup = document.getElementById('info');
                const elem = template_popup.cloneNode(true);
                const h1 = elem.querySelector('#locality'), a = elem.querySelector('#maplink');
                
                const href = decodeURI(document.getElementById('link_map').href).replace('{name}', locality).replace('{lat}', latlng[0].toString()).replace('{lng}', latlng[1].toString());
                
                h1.innerText = locality;
                a.innerText = locality;
                a.href = href;
                
                return elem;
            }

            function navigate()
            {
                const hash = window.location.hash || '';
                const a = document.querySelector(`a.place[data-hash~="${window.location.hash}"]`), img = document.getElementById('photo');
                if(a != null)
                {
                    const div = format_place_info(a);
                    const info = document.getElementById('info');
                    info.innerHTML = div.innerHTML;
                    img.dataset.photohrefs = a.dataset.photohrefs;
                    img.dataset.photohrefsidx = 0;
                    img.hidden = (img.dataset.photohrefs || '').length == 0;
                    img.src = img.hidden ? '' : a.dataset.photohrefs.split(';')[0];
                }
            }

            function img_onclick()
            {
                const img = document.getElementById('photo');
                if(!img.hidden)
                {
                    const photohrefs = img.dataset.photohrefs.split(';');
                    const photohrefsidx = (1 + parseInt(img.dataset.photohrefsidx)) % photohrefs.length;
                    img.src = photohrefs[photohrefsidx];
                    img.dataset.photohrefsidx = photohrefsidx;
                }
            }

            function body_onload()
            {
                const map = L.map('map').setView([20, 0], 2);
                L.tileLayer(decodeURI(document.getElementById('link_tiles').href), {maxZoom: 19, attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a>'}).addTo(map);

                const Icon = L.icon({iconUrl: decodeURI(document.getElementById('link_marker_icon').href), iconSize:     [20, 20], iconAnchor:   [10, 20],  popupAnchor:  [0, -10]  });

                for(const a of document.querySelectorAll('.place'))
                {
                    L.marker(JSON.parse(a.dataset.latlng), {icon: Icon}).bindPopup(format_place_info(a).innerHTML).on('click', () => window.location.hash = a.dataset.hash).addTo(map);
                }

                navigate();
            }

        </script>
        
        <title>{{ page.title }}</title>
    </head>
    <!--<header>
        Event names: <pre>{{ event_names | jsonify }}</pre>, event name: {{ event_name }}
        Places: <pre>{{ places | jsonify }}</pre>
        <ul>{% for p in site.static_files %}<li><pre>{{ p | jsonify }}</pre></li>{% endfor %}</ul>
        <pre>{{ places_grouped_by_country | jsonify }}</pre>
        <h3>Pages</h3>
        Page: <pre>{{ page | jsonify }}</pre>
        Pages: <ul>{% for p in site.pages %}<li><pre>{{ p | jsonify }}</pre></li>{% endfor %}</ul>
        <h3>Site</h3>
        <pre>{{ site | jsonify }}</pre>
    </header>-->

    <body onhashchange="navigate()" onload="body_onload()"> 
        <h1 class="center">{{ page.title }}</h1>
        <!--<h3 class="center">telegram: <a href="{{ page.telegram }}">{{ page.telegram }}</a></h3>-->
        <div class="center">
            {{ page.content | markdownify }}
        </div>
        <hr />


<div id='container'>
<div id="map"></div>
<div id="picBox"><img onclick="img_onclick()" id="photo" style="object-fit:cover; max-width:100%; max-height: 100%; height:auto"></img></div>
</div>

        <div id="info">
            <h1 id="locality">&nbsp;</h1>
            <h3 id="address">&nbsp;<a target="_blank" id="maplink"></a></h3>
        </div>

        <hr />
        <ul id="countries">
        
        {% for country_places in places_grouped_by_country %}
        <li>
            <div class="country">{{ country_places.name }}</div>
            <ul class="places">
                {% for place in country_places.items %} {% assign photos = "" | split: "," %}{% for p in site.static_files %}{% if p.extname == ".jpg" and p.path contains place.dir %}{% assign photo_path_size = p.path | size | minus: 1 %}{% assign photo = p.path | slice: 1, photo_path_size %}{% assign photos = photos | push: photo %}{% endif %}{% endfor %}
                
                <li><a class="place" data-photohrefs="{{ photos | join: ";" }}" data-latlng='{{ place.latlng | jsonify }}' data-locality="{{ place.locality }}" data-hash="#{{ event_name }}_{{ place.locality }}" href="#{{ event_name }}_{{ place.locality }}" class="place"><div>{{ place.locality }}</div><div class="subtitle">{{ place.date | date: "%B %-d, %Y" }}, {{ place.time }}, {{ place.timezone }}</div></a></li>
                {% endfor %}
            </ul>
        </li>
        {% endfor %}
        </ul>
    </body>
    
    <footer>
        <hr />
        <h3 class="center">All events:</h3>
        <ul id="allevents">{% for event in events %}{% assign name_size = event.name | size | minus: 3 %}{% assign d = event.name | slice: 0, name_size %}<li class="event {% if d == event_name %}activeevent{% endif %}"><a href="{{ d }}.html">{{ event.title | xml_escape }}</a></li>{% endfor %}</ul>
        <hr />
        <div>created with <a target="_blank" href="https://github.com/vadimkantorov/eventmap">https://github.com/vadimkantorov/eventmap</a></div>
    </footer>

</html>
